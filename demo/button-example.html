<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>MediumEditor - Button Example</title>
	<link rel="stylesheet" href="css/demo.css">
	<link href="https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">
	<link rel="stylesheet" href="../dist/css/medium-editor.css">
	<link rel="stylesheet" href="../dist/css/themes/bootstrap.css">
</head>

<body>
	<div id="container">
		<h1>Medium Editor</h1>
		Broken:
		<p class="editable">
			My father’s family name is
			<p><br></p>
			<p>Test</p>
		</p>

		Works:
		<div class="editable">
			My father’s family name is
			<p><br></p>
			<p>Test</p>
		</div>
	</div>
	<p style="text-align: center;"><small><a style="color: #333;" target="_blank"
				href="http://www.goodreads.com/reader/475-great-expectations">Source</a></small></p>
	<script src="../dist/js/medium-editor.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/rangy/1.3.0/rangy-core.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/rangy/1.3.0/rangy-classapplier.min.js"></script>

	<script>
		rangy.init();

		var HighlighterButton = MediumEditor.extensions.button.extend({
			name: 'highlighter',
			tagNames: ['mark'],
			contentDefault: '<b>H</b>',
			contentFA: '<i class="fa fa-paint-brush"></i>',
			aria: 'Highlight',
			action: 'highlight',

			init: function () {
				MediumEditor.extensions.button.prototype.init.call(this);

				this.classApplier = rangy.createClassApplier('highlight', {
					elementTagName: 'mark',
					normalize: true
				});
			},

			handleClick: function (event) {


				if (!this.classApplier.isAppliedToSelection()) {
					this.base.saveSelection();
					this.base.restoreSelection();
				}

				this.classApplier.toggleSelection();

				// Ensure the editor knows about an html change so watchers are notified
				// ie: <textarea> elements depend on the editableInput event to stay synchronized
				this.base.checkContentChanged();
			}
		});

		const StrongButton = MediumEditor.extensions.button.extend({
			name: 'strong',
			tagNames: ['strong'],
			contentDefault: '<b>B</b>',
			aria: 'Bold',
			action: 'bold',
			init: function () {
				MediumEditor.extensions.button.prototype.init.call(this);

				this.classApplier = rangy.createClassApplier('strong', {
					elementTagName: 'strong',
					normalize: true,
					onElementCreate: function (elem) {}
				});
			},
			handleClick: function (event) {
				this.classApplier.toggleSelection();

				if (!this.classApplier.isAppliedToSelection()) {
					this.base.saveSelection();

					const range = MediumEditor.selection.getSelectionRange(this.document);
					const documentFragment = range.cloneContents();

					var matches = documentFragment.querySelectorAll('strong.variable');

					for (var i = 0; i < matches.length; i++) {
						let matchParentElem = matches[i].parentElement || documentFragment;
						matchParentElem.insertBefore(matches[i].firstChild, matches[i]);
						matchParentElem.removeChild(matches[i]);
					}

					range.extractContents();
					range.insertNode(documentFragment);
					this.base.restoreSelection();
				}

				this.base.checkContentChanged();
			}
		});

		var editor = new MediumEditor('.editable', {
			toolbar: {
				buttons: ['bold', 'italic', 'underline', 'highlighter', 'strong']
			},
			buttonLabels: 'fontawesome',
			extensions: {
				'highlighter': new HighlighterButton(),
				'strong': new StrongButton()
			}
		});
	</script>
</body>

</html>